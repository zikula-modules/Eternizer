<?php
/**
 * Eternizer.
 *
 * @copyright Michael Ueberschaer (MU)
 * @license http://www.gnu.org/licenses/lgpl.html GNU Lesser General Public License
 * @author Michael Ueberschaer <kontakt@webdesign-in-bremen.com>.
 * @link http://www.webdesign-in-bremen.com
 * @link http://zikula.org
 * @version Generated by ModuleStudio (http://modulestudio.de).
 */

namespace MU\EternizerModule\Form\Handler\Entry;

use MU\EternizerModule\Form\Handler\Entry\Base\AbstractEditHandler;
use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use UserUtil;
use ModUtil;
use LogUtil;

/**
 * This handler class handles the page events of the Form called by the mUEternizerModule_entry_edit() function.
 * It aims on the entry object type.
 * 
 */
class EditHandler extends AbstractEditHandler
{
    /**
     * Initialise existing entity for editing.
     *
     * @return EntityAccess|null Desired entity instance or null
     *
     * @throws NotFoundHttpException Thrown if item to be edited isn't found
     */
    protected function initEntityForEditing()
    {
        $selectionHelper = $this->container->get('mu_eternizer_module.selection_helper');
        $entity = $selectionHelper->getEntity($this->objectType, $this->idValues);
        if (null === $entity) {
            throw new NotFoundHttpException($this->__('No such item.'));
        }
        $controllerHelper = $this->container->get('mu_eternizer_module.controller_helper');
        $editEntryAllowed = $controllerHelper->editEntry($entity['id'], $entity['createdUserId'], $entity['createdDate'], 2);
        
        if ($editEntryAllowed == false && \UserUtil::getVar('uid') != 2) {       	
        	return \System::redirect('/eternizer/entries/view');
        }
        
        // prepare captcha  
        $simpleCaptcha = \ModUtil::getVar('MUEternizerModule', 'simplecaptcha');
        
        // reset captcha
        $session = $this->container->get('session');
        if ($simpleCaptcha && $session->has('formiculaCaptcha')) {      
        	$session->del('eternizerCaptcha');
        }
    
        return parent::initEntityForEditing();
    } 
    
    /**
     * Command event handler.
     *
     * This event handler is called when a command is issued by the user.
     *
     * @param array $args List of arguments
     *
     * @return mixed Redirect or false on errors
     */
    public function handleCommand($args = [])
    {
    	if (\ModUtil::getVar('MUEternizerModule', 'simplecaptcha') == true) {
    		$captcha = $this->request->request->getDigits('captcha', 0);

    		$session = $this->container->get('session');
    		$operands = @unserialize($session->get('eternizerCaptcha'));
    		
    		$captchaHelper = $this->container->get('mu_eternizer_module.captcha_helper');
    		$captchaValid = $captchaHelper->isCaptchaValid($operands, $captcha);
    		if (false === $captchaValid) {
    			\LogUtil::registerError($this->__('The calculation to prevent spam was incorrect. Please try again.'));
    			return false;
    			//$controller->addFlash('error', $this->__('The calculation to prevent spam was incorrect. Please try again.'));
    			//$hasError = true;
    		}
    	}
    	
    	return parent::handleCommand($args);

    }
}
